<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Competizione</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="src/styles.css" />
<style>
/* Trimmed: keep only specifics not in global */
.participants-table th, .participants-table td { padding:8px 10px; border-bottom:1px solid var(--color-border-soft); font-size:13px; }
.participants-table th { background:var(--color-surface-alt); font-size:11px; letter-spacing:.5px; text-transform:uppercase; }
.participants-table tbody tr:hover { background:#eef6ff; }
.club-cell { display:flex; align-items:center; gap:10px; }
.club-cell img { width:34px; height:34px; object-fit:cover; border-radius:10px; border:1px solid var(--color-border-soft); }
</style>
</head>
<body>
<header>
  <h1><a href="competizioni.html" style="color:#2563eb;text-decoration:none;font-size:18px;">&larr; Competizioni</a></h1>
  <nav>
    <a href="index.html">Home</a>
    <a href="listone.html">Listone</a>
    <a href="clubs.html">Club</a>
    <a href="asta.html">Asta</a>
  </nav>
</header>
<main>
  <div id="compHeader" class="fade-in"></div>
  <div id="participantsWrap" class="panel" style="display:none;">
    <h2 class="border-accent">Squadre partecipanti</h2>
    <table class="participants-table" id="participantsTable"><thead><tr><th>Club</th><th>Rosa</th><th>Ingaggi</th><th>Budget</th></tr></thead><tbody></tbody></table>
    <div class="table-note">Rosa / Ingaggi mostrano progress bar di saturazione.</div>
  </div>
</main>
<div id="modalRoot"></div>
<script type="module">
import { ensureAuth } from './src/js/auth.js';
import { initData, saveData } from './src/js/storage.js';
import { syncAllClubBudgets } from './src/js/model.js';
(async () => {
  await ensureAuth();
  let data = await initData();
  syncAllClubBudgets(data);
  data.meta = data.meta || {};
  data.meta.competitions = data.meta.competitions || {}; // store per-competition customizations
  const params = new URLSearchParams(location.search);
  const type = params.get('type'); // 'division' | 'competition'
  const id = params.get('id');
  if(!type || !id) { document.body.innerHTML='<p>Parametri mancanti</p>'; return; }
  let record=null; let recordTypeLabel='';
  if(type==='division') { record = (data.divisions||[]).find(d=>d.id===id); recordTypeLabel='Divisione'; }
  else if(type==='competition') { record = (data.competitions||[]).find(c=>c.id===id); recordTypeLabel = 'Competizione'; }
  if(!record) { document.body.innerHTML='<p>Competizione non trovata</p>'; return; }
  const custom = data.meta.competitions[id] || { colors: ['#334','#667'], logo:'', trophy:'' };
  data.meta.competitions[id] = custom; // ensure
  saveData(data);
  function buildHeader(){
    const [c1,c2] = custom.colors.length? custom.colors : ['#334','#667'];
    const gradient = `linear-gradient(110deg, ${c1}, ${c2})`;
    const logoHtml = custom.logo ? `<img src="${custom.logo}" alt="logo" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : record.name.split(' ').map(w=>w[0]).slice(0,3).join('');
    const trophyHtml = custom.trophy ? `<img src="${custom.trophy}" alt="trophy" style="max-width:100%;max-height:100%;object-fit:contain;"/>` : 'üèÜ';
    const h = document.getElementById('compHeader');
    h.innerHTML = `<section class='hero' style='background:${gradient};margin-top:0;'>`+
      `<h1 style='margin:0 0 6px;'>${record.name}</h1>`+
      `<p class='subtitle' style='max-width:760px;'>${recordTypeLabel} personalizzabile con colori, logo e trofeo statici.</p>`+
      `<div style='display:flex; gap:18px; align-items:center; flex-wrap:wrap; margin-top:14px;'>`+
        `<div style='display:flex; gap:14px; align-items:center;'>`+
          `<div style='width:90px;height:90px;background:#ffffff22;border:2px solid #ffffff55;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:700;overflow:hidden;'>${logoHtml}</div>`+
          `<div style='width:90px;height:90px;background:#ffffff22;border:2px solid #ffffff55;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:46px;'>${trophyHtml}</div>`+
        `</div>`+
        `<div style='flex:1;min-width:240px;'>`+
          `<div style='display:flex;flex-wrap:wrap;gap:14px;font-size:13px;'>`+
            `<span><strong>Tipo:</strong> ${recordTypeLabel}</span>`+
            `<span><strong>Campione in carica:</strong> <span id='champHolder'>-</span></span>`+
            `<button class='btn-outline btn-sm' id='editCompBtn'>Modifica</button>`+
          `</div>`+
        `</div>`+
      `</div>`+
    `</section>`;
    document.getElementById('editCompBtn').addEventListener('click', openEditCompetitionModal);
  }
  buildHeader();
  // Show participants only for divisions for now
  if(type==='division') {
    document.getElementById('participantsWrap').style.display='block';
    renderParticipants();
  }
  function renderParticipants(){
    const tbody = document.querySelector('#participantsTable tbody');
    tbody.innerHTML='';
    const clubs = data.clubs.filter(c=>c.divisionId===id);
    clubs.forEach(c => {
      const [c1,c2] = c.colors||['#222','#eee'];
      const logo = c.logo ? `<img src='${c.logo}' alt='logo'>` : `<div style='width:34px;height:34px;display:flex;align-items:center;justify-content:center;background:${c1};color:${c2};font-weight:700;border-radius:10px;'>${c.name[0]||'?'}<div>`;
      const rosterCount = c.roster.filter(r=>r.status==='active').length;
      const rosterPerc = Math.min(100, Math.round(rosterCount/30*100));
      const wagePerc = Math.min(100, Math.round((c.wageTotal||0)/110*100));
      const budgetCls = c.budget>=300?'high': (c.budget>=120?'mid':'low');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a class='club-cell' href='club.html?id=${c.id}'>${logo}<span>${c.name}</span></a></td>`+
        `<td>${rosterCount}/30<div class='mini-progress'><span style='width:${rosterPerc}%;'></span></div></td>`+
        `<td>${c.wageTotal}/110<div class='mini-progress wage'><span style='width:${wagePerc}%;'></span></div></td>`+
        `<td><span class='badge-budget ${budgetCls}'>${c.budget}</span></td>`;
      tbody.appendChild(tr);
    });
  }
  function openEditCompetitionModal(){
    const root = document.getElementById('modalRoot');
    const palette = ['#003366','#004c99','#0077b6','#0f766e','#15803d','#a21caf','#be123c','#c48c00','#111827','#6d28d9','#dc2626','#2563eb','#16a34a','#64748b'];
    const legacyLogo = custom.logo && /^data:/i.test(custom.logo);
    const legacyTrophy = custom.trophy && /^data:/i.test(custom.trophy);
    root.innerHTML = `<div class='modal-overlay'><div class='modal'>
      <h3>Modifica ${record.name}</h3>
      <form id='editCompForm'>
        <label>Path Logo <input name='logoPath' placeholder='media/logo_comp.webp' value='${legacyLogo?"":(custom.logo||"")}'></label>
        <label>Path Trofeo <input name='trophyPath' placeholder='media/trophy_comp.webp' value='${legacyTrophy?"":(custom.trophy||"")}'></label>
        ${(legacyLogo||legacyTrophy)?`<div style='background:#fff3cd;color:#7c5e00;padding:6px 8px;border-radius:6px;font-size:11px;margin-bottom:6px;'>Rilevati dataURL legacy: sostituisci con file statici in media/.</div>`:''}
        <small style='display:block;margin:6px 0 10px;font-size:11px;color:#555;'>Inserisci percorsi relativi ai file statici (cartella media/). Esempio: media/superleague.webp</small>
        <div><strong>Colori</strong><div class='color-picker-grid' id='colorGrid'></div></div>
        <div style='display:flex; gap:8px; justify-content:flex-end; margin-top:16px;'>
          <button type='button' id='cancelCompEdit'>Annulla</button>
          <button type='submit'>Salva</button>
        </div>
      </form>
    </div></div>`;
    const grid = document.getElementById('colorGrid');
    let sel = [...(custom.colors||[])];
    function renderSwatches(){
      grid.innerHTML='';
      palette.forEach(col => { const div=document.createElement('div'); div.className='color-swatch'+(sel.includes(col)?' selected':''); div.style.background=col; div.addEventListener('click',()=>{ if(sel.includes(col)){ sel=sel.filter(c=>c!==col); } else { if(sel.length<2) sel.push(col); else { sel[1]=col; } } renderSwatches(); }); grid.appendChild(div); });
    }
    renderSwatches();
    document.getElementById('cancelCompEdit').addEventListener('click', ()=> root.innerHTML='');
    document.getElementById('editCompForm').addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      if(sel.length) custom.colors = sel;
      const lp = fd.get('logoPath').trim();
      const tp = fd.get('trophyPath').trim();
      if(lp) custom.logo = lp; else if(!/^data:/i.test(custom.logo)) custom.logo='';
      if(tp) custom.trophy = tp; else if(!/^data:/i.test(custom.trophy)) custom.trophy='';
      saveData(data);
      root.innerHTML='';
      buildHeader();
      if(type==='division') renderParticipants();
    });
  }
})();
</script>
</body>
</html>
