<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Club - Bar Birsa Super League Official App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="src/styles.css" />
<!-- Palette ruoli centralizzata in styles.css -->
</head>
<style>
/* Gradient hero box for Gestione Club */
.club-hero-box { --bbsl-c1:#1e3a8a; --bbsl-c2:#2563eb; background:linear-gradient(135deg,var(--bbsl-c1),var(--bbsl-c2)); color:#fff; padding:34px 180px 40px 42px; border-radius:32px; box-shadow:0 10px 34px -14px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,0.08); position:relative; overflow:hidden; display:flex; align-items:flex-start; gap:38px;}
.club-hero-box:before {content:""; position:absolute; inset:0; background:radial-gradient(circle at 25% 20%,rgba(255,255,255,0.18),transparent 60%), radial-gradient(circle at 75% 70%,rgba(255,255,255,0.12),transparent 65%); mix-blend-mode:overlay; pointer-events:none;}
.club-hero-left {position:absolute; top:18px; right:26px; flex:none;}
.club-hero-logo {height:100px; width:auto; object-fit:contain; filter:drop-shadow(0 8px 24px rgba(0,0,0,.55)); opacity:.95;}
.club-hero-content {flex:1 1 auto; position:relative; z-index:2;}
.club-hero-content h1 {margin:0 0 10px; font-size:42px; letter-spacing:1px; line-height:1.05;}
.club-hero-content .subtitle {color:#e8f2ff; max-width:880px; margin:0 0 20px; font-size:15px;}
.club-hero-stats {display:flex; gap:26px; flex-wrap:wrap;}
.club-hero-stats .stat-card {background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); padding:14px 18px; border-radius:18px; min-width:140px; box-shadow:0 4px 16px -8px rgba(0,0,0,.5);}
.club-hero-stats .stat-card h3 {margin:0 0 6px; font-size:13px; font-weight:600; letter-spacing:.7px; text-transform:uppercase; opacity:.85;}
.club-hero-stats .stat-card .value {font-size:26px; font-weight:700;}
@media (max-width:900px){ .club-hero-box {padding:32px 30px 34px; gap:26px;} .club-hero-left {position:absolute; top:18px; right:22px;} .club-hero-logo {height:82px;} .club-hero-content h1 {font-size:36px;} }
@media (max-width:560px){ .club-hero-box {padding:28px 26px 32px;} .club-hero-content h1 {font-size:32px;} .club-hero-left {top:14px; right:18px;} .club-hero-logo {height:68px;} .club-hero-stats {gap:18px;} }
</style>
<body>
<header class="global-top-bar site-nav">
  <div class="brand"><span class="dot"></span><span>BBSL</span></div>
  <nav aria-label="Navigazione principale">
    <a href="home.html">Home</a>
    <a href="clubs.html">Club</a>
    <a href="competizioni.html">Competizioni</a>
    <a href="listone.html">Listone</a>
    <a href="asta.html">Asta</a>
  <a href="albo.html">Albo d'oro</a>
  <a href="index.html">Savegame</a>
  </nav>
</header>
<main>
  <section class="fade-in" style="margin-top:0;">
    <div class="club-hero-box">
      <div class="club-hero-left"><img src="media/BBSL_logo_nero.png" alt="Logo BBSL" class="club-hero-logo" /></div>
      <div class="club-hero-content">
        <h1>Gestione Club</h1>
        <p class="subtitle">Crea e mantieni i club, visualizza divisioni e competizioni. Monitora rapidamente roster, ingaggi e budget correnti.</p>
        <div class="club-hero-stats" id="clubsHeroStats">
          <div class="stat-card"><h3>Club Totali</h3><div class="value" id="heroClubCount">-</div></div>
          <div class="stat-card"><h3>Ingaggi Totali</h3><div class="value" id="heroWageTotal">-</div></div>
          <div class="stat-card"><h3>Budget Totale</h3><div class="value" id="heroBudgetTotal">-</div></div>
        </div>
      </div>
    </div>
  </section>
  <section class="panel">
    <h2 class="border-accent">Nuovo Club</h2>
    <form id="addClubForm" style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
      <input name="name" placeholder="Nome" required />
      <input name="president" placeholder="Presidente" />
      <input name="founded" placeholder="Anno fondazione" />
      <input name="stadium" placeholder="Stadio" />
      <input name="colors" placeholder="Colori (#hex,#hex)" />
      <select name="divisionId" id="divisionSelect"><option value="">Divisione</option></select>
      <button class="btn-secondary">Crea Club</button>
    </form>
  </section>
  <section class="panel">
    <h2 class="border-accent">Elenco Club</h2>
    <div id="clubsList" class="cards"></div>
  </section>
</main>
<script type="module">
import { ensureAuth } from './src/js/auth.js';
import { initData, saveData } from './src/js/storage.js';
import { addClub, syncAllClubBudgets } from './src/js/model.js';
import { announce, uiAlert } from './src/js/ui.js';
(async () => {
  await ensureAuth();
  let data = await initData();
  try {
    const compColors = data.meta?.competitions?.['div_a']?.colors;
    if(Array.isArray(compColors) && compColors.length){
      const c1 = compColors[0];
      const c2 = compColors[1] || compColors[0];
      document.querySelectorAll('.club-hero-box').forEach(b=>{ b.style.setProperty('--bbsl-c1', c1); b.style.setProperty('--bbsl-c2', c2); });
    }
  } catch(e) {}
  // Sync budgets
  syncAllClubBudgets(data);
  const orderIndex = (data.rolesOrder||[]).reduce((m,r,i)=>{m[r]=i;return m;},{});
  const sortRoles = roles => roles.slice().sort((a,b)=> (orderIndex[a]??99)-(orderIndex[b]??99));
  const roleClass = r => { if (r==='POR') return 'role-gk'; if (['B','DC','DD','DS'].includes(r)) return 'role-def'; if (['E','M','C'].includes(r)) return 'role-mid'; if (['W','T'].includes(r)) return 'role-wing'; if (['A','PC'].includes(r)) return 'role-att'; return 'role-mid'; };
  const roleBadgesHTML = roles => `<span class='role-badges'>${sortRoles(roles).map(r=>`<span class=\"role-badge ${roleClass(r)}\">${r}</span>`).join('')}</span>`;
  data.players.forEach(p=>{ if(Array.isArray(p.roles)) p.roles = sortRoles(p.roles); });
  const divSel = document.getElementById('divisionSelect');
  function refreshDivisionSelect() {
    divSel.innerHTML = '<option value="">Divisione</option>';
    (data.divisions||[]).forEach(d => { const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; divSel.appendChild(o); });
  }
  // RIMOSSI pannelli Divisioni & Competizioni dalla UI (dati ancora disponibili in 'data')
  function contrastColor(hex){
    if(!/^#?[0-9a-fA-F]{6}$/.test(hex||'')) return '#fff';
    const h = hex.replace('#','');
    const r = parseInt(h.slice(0,2),16), g = parseInt(h.slice(2,4),16), b = parseInt(h.slice(4,6),16);
    // luminanza percepita
    const L = (0.299*r + 0.587*g + 0.114*b)/255;
    return L > 0.55 ? '#111' : '#fff';
  }
  const logoExts = ['png','PNG','jpg','JPG','jpeg','JPEG'];
  function guessLogoBase(name){ return 'media/' + name + '_Logo'; }
  function nextLogoSrc(base, idx){ return base + '.' + logoExts[idx]; }
  window._clubLogoOnError = function(img){
    const base = img.dataset.base;
    let idx = parseInt(img.dataset.extIdx||'0',10);
    if(idx < logoExts.length-1){ idx++; img.dataset.extIdx = idx; img.src = nextLogoSrc(base, idx); }
    else { img.onerror = null; img.replaceWith(creaFallbackLogo(base.split('/').pop()[0]||'?')); }
  };
  function creaFallbackLogo(letter){ const span = document.createElement('span'); span.className='logo-fallback'; span.textContent=letter.toUpperCase(); return span; }
  const list = document.getElementById('clubsList');
  function badgeBudgetClass(val){ if(val>=300) return 'high'; if(val>=120) return 'mid'; return 'low'; }
  function renderClubs() {
    list.innerHTML = '';
    let totalWage=0, totalBudget=0;
    data.clubs.forEach(c => { totalWage += (c.wageTotal||0); totalBudget += (c.budget||0); });
    document.getElementById('heroClubCount').textContent = data.clubs.length;
    document.getElementById('heroWageTotal').textContent = totalWage;
    document.getElementById('heroBudgetTotal').textContent = totalBudget;
    data.clubs.forEach(c => {
      const card = document.createElement('div');
      card.className = 'club-card fade-in';
      const [raw1, raw2] = c.colors && c.colors.length ? c.colors : ['#222','#555'];
      const c1 = raw1; const c2 = raw2 || raw1;
      const textCol = contrastColor(c1);
      card.style.borderColor = c1;
      const division = data.divisions.find(d=>d.id===c.divisionId);
      const wagePerc = Math.min(100, Math.round((c.wageTotal||0)/110*100));
      const rosterCount = c.roster.filter(r=>r.status==='active').length;
      const rosterPerc = Math.min(100, Math.round(rosterCount/30*100));
      const headerGradient = `linear-gradient(90deg, ${c1}, ${c2})`;
      let logoHtml;
      if(c.logo) {
        // Usa direttamente il path salvato (preferenza assoluta). Fallback lettera su errore.
        logoHtml = `<img src='${c.logo}' alt='Logo ${c.name}' onerror="this.onerror=null; this.replaceWith(creaFallbackLogo('${(c.name||'?').charAt(0)}'));" style='width:100%;height:100%;object-fit:contain;' />`;
      } else {
        const logoBase = guessLogoBase(c.name);
        logoHtml = `<img data-base='${logoBase}' data-ext-idx='0' src='${logoBase}.png' alt='Logo ${c.name}' onerror="_clubLogoOnError(this)" style='width:100%;height:100%;object-fit:contain;' />`;
      }
      card.innerHTML = `
        <h3 style="background:${headerGradient};color:#fff;display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;">
          <span class='club-logo-mini' style="background:linear-gradient(135deg,${c1},${c2});width:34px;height:34px;border-radius:10px;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;">${logoHtml}</span>
          <a href='club.html?id=${c.id}' style='color:#fff;text-decoration:none;font-weight:600;flex:1 1 auto;'>${c.name}</a>
        </h3>
  <p style='margin:6px 0 10px;font-size:12px;'>Pres: ${c.president||'-'}</p>
        <div style='display:flex; flex-direction:column; gap:6px;'>
          <div style='display:flex;justify-content:space-between;font-size:11px;'><span>Rosa</span><span>${rosterCount}/30</span></div>
          <div class='mini-progress' style='background:linear-gradient(90deg,${c1}33,${c2}33);'><span style='width:${rosterPerc}%;background:linear-gradient(90deg,${c1},${c2});'></span></div>
          <div style='display:flex;justify-content:space-between;font-size:11px;'><span>Ingaggi</span><span>${c.wageTotal}/110</span></div>
          <div class='mini-progress' style='background:linear-gradient(90deg,${c1}33,${c2}33);'><span style='width:${wagePerc}%;background:linear-gradient(90deg,${c1},${c2});'></span></div>
          <div style='display:flex;justify-content:space-between;font-size:11px;'><span>Budget</span><span><span class='badge-budget ${'badge-budget '+badgeBudgetClass(c.budget||0)}'>${c.budget}</span></span></div>
        </div>`;
      list.appendChild(card);
    });
  }
  refreshDivisionSelect();
  (function markCurrent(){ const cur=location.pathname.split('/').pop().toLowerCase(); document.querySelectorAll('.site-nav nav a').forEach(a=>{ if(a.getAttribute('href').toLowerCase()===cur){ a.classList.add('active'); a.setAttribute('aria-current','page'); } }); })();
  renderClubs();
  document.getElementById('addClubForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const colors = (fd.get('colors')||'').split(',').map(s=>s.trim()).filter(Boolean);
    addClub(data, {
      name: fd.get('name'),
      president: fd.get('president'),
      founded: fd.get('founded'),
      stadium: fd.get('stadium'),
      colors,
      divisionId: fd.get('divisionId')||null
    });
    saveData(data);
    e.target.reset();
    renderClubs();
    announce('Club creato');
  });
})();
</script>
</body>
</html>
